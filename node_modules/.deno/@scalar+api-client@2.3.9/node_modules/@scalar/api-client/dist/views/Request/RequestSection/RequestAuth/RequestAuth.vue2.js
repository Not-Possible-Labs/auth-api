import { defineComponent as I, useId as L, ref as D, computed as h, openBlock as m, createBlock as N, withCtx as d, createElementVNode as i, unref as r, toDisplayString as k, createElementBlock as p, normalizeClass as z, createCommentVNode as E, createVNode as f, Fragment as x, createTextVNode as q } from "vue";
import { useModal as K, ScalarComboboxMultiselect as W, ScalarButton as F, ScalarIcon as G } from "@scalar/components";
import { isDefined as H } from "@scalar/oas-utils/helpers";
import J from "../../../../components/ViewLayout/ViewLayoutCollapse.vue.js";
import { useLayout as P } from "../../../../hooks/useLayout.js";
import { useWorkspace as Q } from "../../../../store/store.js";
import X from "./DeleteRequestAuthModal.vue.js";
import Y from "./RequestAuthDataTable.vue.js";
import { getSecurityRequirements as Z, formatComplexScheme as _, formatScheme as ee, getSchemeOptions as te } from "../../libs/auth.js";
const le = ["id"], oe = { class: "-mx-1 flex flex-1" }, ne = { class: "text-c-1" }, he = /* @__PURE__ */ I({
  __name: "RequestAuth",
  props: {
    collection: {},
    environment: {},
    envVariables: {},
    layout: {},
    operation: {},
    selectedSecuritySchemeUids: {},
    server: {},
    title: {},
    workspace: {}
  },
  setup(s) {
    const { layout: v } = P(), {
      securitySchemes: S,
      securitySchemeMutators: O,
      requestMutators: w,
      collectionMutators: M
    } = Q(), R = L(), C = D(null), y = K(), b = D(
      null
    ), A = h(() => {
      const e = Z(s.operation, s.collection);
      return { filteredRequirements: e.filter((o) => Object.keys(o).length), requirements: e };
    }), g = h(() => {
      const { filteredRequirements: e, requirements: t } = A.value;
      if (!t.length)
        return null;
      const n = !t.some(
        (u) => Object.keys(u).length > 1
      ) && e.length < t.length, l = n ? "Unlock" : "Lock", c = n ? "Optional" : "Required", j = `${e.length === 1 ? (() => {
        const u = Object.keys(e[0] || {});
        return u.length > 1 ? u.join(" & ") : u[0] || "";
      })() : ""} ${c}`;
      return { icon: l, text: j };
    }), a = h(
      () => s.selectedSecuritySchemeUids.map((e) => {
        if (Array.isArray(e))
          return _(e, S);
        const t = S[e ?? ""];
        if (t)
          return ee(t);
      }).filter(H)
    );
    function U(e) {
      var n;
      const t = e.find((l) => l.payload), o = e.filter((l) => !l.payload).map(({ id: l }) => {
        const c = l.split(",");
        return c.length > 1 ? c : l;
      });
      if (t != null && t.payload) {
        const l = O.add(
          t.payload,
          (n = s.collection) == null ? void 0 : n.uid
        );
        l && o.push(l.uid);
      }
      V(o);
    }
    const V = (e) => {
      var t;
      v === "modal" || s.layout === "reference" ? M.edit(s.collection.uid, "selectedSecuritySchemeUids", e) : (t = s.operation) != null && t.uid && w.edit(s.operation.uid, "selectedSecuritySchemeUids", e);
    };
    function $({ id: e, label: t }) {
      b.value = { id: e, label: t }, y.show();
    }
    const B = (e) => {
      var o;
      if (!e)
        return;
      const t = s.selectedSecuritySchemeUids.filter((n) => {
        const l = e.split(",");
        return l.length > 1 && Array.isArray(n) && l.length === n.length ? n.every((c) => !l.includes(c)) : n !== e;
      });
      V(t), (o = C.value) == null || o.$el.focus(), y.hide();
    }, T = h(
      () => {
        var e;
        return te(
          A.value.filteredRequirements,
          ((e = s.collection) == null ? void 0 : e.securitySchemes) ?? [],
          S,
          v === "modal" || s.layout === "reference"
        );
      }
    );
    return (e, t) => (m(), N(J, {
      class: "group/params",
      itemCount: a.value.length,
      layout: e.layout
    }, {
      title: d(() => [
        i("div", {
          id: r(R),
          class: "inline-flex items-center gap-1"
        }, [
          i("span", null, k(e.title), 1),
          g.value ? (m(), p("span", {
            key: 0,
            class: z(["text-c-3 text-xs leading-[normal]", { "text-c-1": g.value.text === "Required" }])
          }, k(g.value.text), 3)) : E("", !0)
        ], 8, le)
      ]),
      actions: d(() => [
        i("div", oe, [
          f(r(W), {
            class: "w-72 text-xs",
            isDeletable: r(v) !== "modal" && e.layout !== "reference",
            modelValue: a.value,
            multiple: "",
            options: T.value,
            onDelete: $,
            "onUpdate:modelValue": U
          }, {
            default: d(() => [
              f(r(F), {
                ref_key: "comboboxButtonRef",
                ref: C,
                "aria-describedby": r(R),
                class: "hover:bg-b-3 text-c-1 hover:text-c-1 py-0.25 h-fit px-1.5 font-normal",
                fullWidth: "",
                variant: "ghost"
              }, {
                default: d(() => {
                  var o;
                  return [
                    i("div", ne, [
                      a.value.length === 0 ? (m(), p(x, { key: 0 }, [
                        t[2] || (t[2] = i("span", { class: "sr-only" }, "Select", -1)),
                        t[3] || (t[3] = q(" Auth Type "))
                      ], 64)) : a.value.length === 1 ? (m(), p(x, { key: 1 }, [
                        t[4] || (t[4] = i("span", { class: "sr-only" }, "Selected Auth Type:", -1)),
                        q(" " + k((o = a.value[0]) == null ? void 0 : o.label), 1)
                      ], 64)) : (m(), p(x, { key: 2 }, [
                        t[5] || (t[5] = q(" Multiple ")),
                        t[6] || (t[6] = i("span", { class: "sr-only" }, "Auth Types Selected", -1))
                      ], 64))
                    ]),
                    f(r(G), {
                      class: "ml-1 shrink-0",
                      icon: "ChevronDown",
                      size: "sm"
                    })
                  ];
                }),
                _: 1
              }, 8, ["aria-describedby"])
            ]),
            _: 1
          }, 8, ["isDeletable", "modelValue", "options"])
        ])
      ]),
      default: d(() => [
        f(Y, {
          collection: e.collection,
          envVariables: e.envVariables,
          environment: e.environment,
          layout: e.layout,
          selectedSchemeOptions: a.value,
          server: e.server,
          workspace: e.workspace
        }, null, 8, ["collection", "envVariables", "environment", "layout", "selectedSchemeOptions", "server", "workspace"]),
        f(X, {
          scheme: b.value,
          state: r(y),
          onClose: t[0] || (t[0] = (o) => r(y).hide()),
          onDelete: t[1] || (t[1] = (o) => {
            var n;
            return B((n = b.value) == null ? void 0 : n.id);
          })
        }, null, 8, ["scheme", "state"])
      ]),
      _: 1
    }, 8, ["itemCount", "layout"]));
  }
});
export {
  he as default
};
